<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRYO-CHAMBER V42.0 [ULTIMATE FUNCTIONAL SYSTEM]</title>
    <style>
        /* --- UNIVERSAL RESET --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #050505;
            color: #e0f7fa;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            width: 100%; min-height: 100vh;
            padding-bottom: 80px;
        }

        /* --- SCROLLBARS --- */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; }

        /* --- PRE-SESSION MODAL --- */
        #pre-session-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }
        .modal-card {
            background: #001f3f; padding: 30px; border-radius: 10px; max-width: 90%;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
            animation: zoomIn 0.3s;
        }
        @keyframes zoomIn { from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }
        .modal-title { color: #00e5ff; font-size: 24px; margin-bottom: 10px; border-bottom: 1px solid #00e5ff; padding-bottom: 5px; }
        .modal-warn { color: #ff5252; font-size: 14px; margin: 15px 0; }
        .modal-instruct { text-align: left; margin: 20px 0; font-size: 14px; }
        .volume-visual { border: 1px solid #00e5ff; padding: 10px; margin-top: 15px; background: #000a12; }

        /* --- ARCHITECT CONSOLE --- */
        #architect-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 30, 0.95); z-index: 9000;
            display: none; flex-direction: column; align-items: center; padding: 20px;
            font-family: monospace;
        }
        .architect-header { color: #ffd700; font-size: 20px; border-bottom: 2px solid #ffd700; padding-bottom: 10px; margin-bottom: 20px; }
        .architect-btn {
            width: 100%; max-width: 400px; padding: 15px; margin: 10px 0;
            background: #333; color: #fff; border: 1px solid #ffd700; cursor: pointer;
            font-size: 16px; transition: background 0.2s;
        }
        .architect-close { color: #888; font-size: 12px; margin-top: 20px; cursor: pointer; }


        /* --- NAV BAR --- */
        .nav-bar {
            display: flex; width: 100%; background: #0a0a0a;
            border-bottom: 2px solid #00e5ff;
            position: sticky; top: 0; z-index: 1000;
            overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .nav-btn {
            flex: 1; min-width: 80px; padding: 15px 5px; background: #0a0a0a; color: #666;
            border: none; border-right: 1px solid #222; font-weight: bold; font-size: 12px; cursor: pointer; white-space: nowrap;
            font-family: monospace;
        }
        .nav-btn.active { background: #00e5ff; color: #000; }

        /* --- CONTENT --- */
        .content-wrapper { padding: 20px; flex: 1; max-width: 800px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; }
        .tab-panel { display: none; width: 100%; flex: 1; }
        .tab-panel.visible { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* --- DR. ARCH (AI INTERFACE) --- */
        .doctor-header {
            display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px;
            border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .doctor-avatar {
            width: 50px; height: 50px; background: #00e5ff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; font-size: 24px;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.5); cursor: pointer;
        }
        .doctor-info { font-size: 12px; color: #aaa; } .doctor-name { font-size: 18px; color: #fff; font-weight: bold; }

        .chat-window {
            flex: 1; min-height: 350px; max-height: 500px;
            background: #080808; border: 1px solid #333; border-radius: 8px;
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
        }
        .msg-row { display: flex; gap: 10px; }
        .msg-ai-bubble {
            background: #1a1a1a; color: #e0f7fa; padding: 15px; border-radius: 0 15px 15px 15px;
            max-width: 85%; font-size: 14px; line-height: 1.5; border-left: 3px solid #00e5ff;
        }
        .msg-user-bubble {
            background: #004d40; color: #fff; padding: 10px 15px; border-radius: 15px 15px 0 15px;
            max-width: 80%; font-size: 13px; margin-left: auto; text-align: right;
        }
        
        .choice-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; width: 100%; }
        .choice-btn:hover { border-color: #00e5ff; color: #00e5ff; background: rgba(0, 229, 255, 0.05); }

        .prescription-card {
            background: #002220; border: 1px solid #00e5ff; padding: 20px; margin-top: 10px; border-radius: 8px; text-align: center;
            animation: slideUp 0.5s;
        }
        .rx-header { color: #00e5ff; font-size: 12px; letter-spacing: 2px; margin-bottom: 5px; }
        .rx-title { color: #fff; font-size: 22px; font-weight: bold; margin-bottom: 10px; }
        .rx-time { font-family: monospace; color: #ffd700; font-size: 14px; border: 1px solid #ffd700; display: inline-block; padding: 5px 10px; border-radius: 4px; margin-bottom: 15px; }

        /* --- CHAT INPUT AREA --- */
        #chat-input-area {
            display: flex; margin-top: 15px; padding: 10px 0; border-top: 1px solid #1a1a1a;
            position: sticky; bottom: 0; background: #080808;
        }
        #chat-input {
            flex-grow: 1; padding: 12px; font-size: 15px; border: 1px solid #333;
            background: #111; color: #fff; border-radius: 4px 0 0 4px;
        }
        #chat-send-btn {
            background: #00e5ff; color: #000; font-weight: bold; padding: 10px 15px;
            border: none; cursor: pointer; border-radius: 0 4px 4px 0;
            transition: background 0.2s; font-size: 14px;
        }
        #chat-send-btn:hover { background: #00bfa5; }


        /* --- CONTROL PANEL --- */
        .system-group { margin-bottom: 20px; }
        .system-label { font-size: 10px; color: #888; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .med-btn {
            width: 100%; background: #111; border: 1px solid #333; border-left-width: 4px;
            color: #ccc; padding: 15px; margin-bottom: 8px; text-align: left; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s; border-radius: 0 4px 4px 0;
        }
        .med-btn:hover { background: #1a1a1a; color: #fff; }
        .med-btn.active-protocol { background: #1a1a1a; color: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.5); border-color: #fff; }
        
        .border-fire { border-left-color: #ff5252; } .border-earth { border-left-color: #69f0ae; }
        .border-water { border-left-color: #40c4ff; } .border-air { border-left-color: #e040fb; }
        .border-aether { border-left-color: #ffd740; } .border-void { border-left-color: #fff; }
        .btn-icon { font-size: 18px; margin-right: 10px; width: 20px; text-align: center; }
        .btn-main { font-weight: bold; font-size: 14px; } .btn-desc { font-size: 11px; color: #666; } 
        .btn-meta { text-align: right; }
        .btn-freq { font-family: monospace; font-size: 10px; color: #00e5ff; }
        .btn-time { font-family: monospace; font-size: 10px; color: #ffd700; }

        /* --- ENVIRONMENTAL REGULATOR (NEW) --- */
        .regulator-panel {
            background: #111; border: 1px solid #333; padding: 10px; margin-bottom: 20px; border-radius: 4px;
        }
        .regulator-label { font-size: 10px; color: #ffd700; margin-bottom: 5px; text-transform: uppercase; }
        .regulator-control { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; }
        .regulator-status { font-size: 13px; font-weight: bold; color: #aaa; }
        .status-active { color: #69f0ae !important; }
        .toggle-btn { background: #004d40; border: none; color: #fff; padding: 6px 12px; cursor: pointer; font-size: 11px; border-radius: 3px; }

        /* --- BIO & STATUS --- */
        .bio-bar {
            display: flex; align-items: center; justify-content: space-between;
            background: #0a0a0a; border: 1px solid #333; padding: 10px; margin-bottom: 15px;
            border-left: 4px solid #333; transition: border-color 0.5s; border-radius: 4px;
        }
        .bio-val { font-size: 20px; font-weight: bold; color: #fff; } .bio-label { font-size: 10px; color: #888; text-transform: uppercase; }
        .bio-btn { background: #222; border: 1px solid #555; color: #fff; padding: 5px 10px; font-size: 10px; cursor: pointer; border-radius: 4px; }
        .status-box { border: 1px solid #333; background: #0a0a0a; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; border-bottom: 1px solid #222; padding-bottom: 4px; color: #aaa; }
        .value-text { color: #fff; font-family: monospace; }

        /* --- DATA ARCHIVE --- */
        .terminal-window { 
            width: 100%; height: 350px; background: #e0e0e0; color: #111;
            border: 1px solid #fff; font-family: monospace; font-size: 11px;
            padding: 10px; overflow-y: scroll; white-space: pre; user-select: text; -webkit-user-select: text;
        }
        .data-controls { display: flex; gap: 5px; margin-top: 10px; }
        .data-btn { flex: 1; padding: 10px; background: #222; color: #fff; border: 1px solid #444; cursor: pointer; }
        .instruct-text { font-size: 11px; color: #888; margin-bottom: 5px; text-align: center; }

        /* --- BREATH --- */
        .breath-box { height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .circle { width: 100px; height: 100px; border: 4px solid #00e5ff; border-radius: 50%; opacity: 0.3; transform: scale(0.8); transition: all 5.5s ease-in-out; }
        .circle.inhale { transform: scale(2.0); opacity: 1; } .circle.exhale { transform: scale(0.8); opacity: 0.3; }
        
        /* --- GLOBAL FOOTER --- */
        .global-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 70px; background: #080808; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            z-index: 5000; padding: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        .global-btn {
            width: 100%; height: 100%; max-width: 600px;
            font-size: 16px; font-weight: bold; letter-spacing: 1px;
            border: none; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s; border-radius: 4px;
        }
        .btn-idle { background: #222; color: #666; border: 1px solid #333; }
        .btn-active { background: #b71c1c; color: #fff; border: 1px solid #ff5252; animation: pulse-red 2s infinite; }
        .btn-resume { background: #004d40; color: #00e5ff; border: 1px solid #00bfa5; }
        @keyframes pulse-red { 0% {box-shadow: 0 0 5px #b71c1c;} 50% {box-shadow: 0 0 15px #ff5252;} 100% {box-shadow: 0 0 5px #b71c1c;} }

        .mode-banner { display: flex; justify-content: space-between; align-items: center; background: #0a0a0a; border: 1px solid #333; padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .current-mode-text { font-size: 12px; color: #888; } .mode-name { font-size: 14px; font-weight: bold; color: #00e5ff; }
        .change-mode-btn { background: #222; color: #fff; border: 1px solid #555; padding: 6px 12px; font-size: 10px; cursor: pointer; border-radius: 3px; }
        .apply-btn { background: #00e5ff; color: #000; font-weight: bold; padding: 15px; width: 100%; cursor: pointer; border: none; margin-top: 15px; text-transform: uppercase; border-radius: 4px; }

    </style>
</head>
<body onload="initAppSetup()">

    <div id="pre-session-modal">
        <div class="modal-card">
            <div class="modal-title" id="modal-title">PROTOCOL: TETRAHEDRON</div>
            <div class="modal-warn">CRITICAL: Review Volume Setting Before Continuing.</div>
            <div class="modal-instruct" id="modal-instruct-text"></div>
            
            <div class="volume-visual">
                            </div>

            <button class="apply-btn" onclick="startTreatmentNow()">START TREATMENT NOW</button>
        </div>
    </div>
    
    <div id="architect-console">
        <div class="architect-header">ARCHITECT CONSOLE: ADVANCED SYNTHESIS</div>
        <button class="architect-btn" onclick="toggleArchitectMode(); showPreSessionModal('DISCHARGE_33')">
            GAMMA DISCHARGE (33Hz) âš¡
        </button>
        <button class="architect-btn" onclick="toggleArchitectMode(); showPreSessionModal('Icosahedron_Intent')">
            ACAUSAL CLARITY (Flow State)
        </button>
        <button class="architect-btn" onclick="toggleArchitectMode(); showPreSessionModal('Stellated_Dodecahedron')">
            STELLATED DODECAHEDRON (Expansion) âœ¨
        </button>
        <div class="architect-close" onclick="toggleArchitectMode()">[ CLOSE CONSOLE ]</div>
    </div>


    <div class="nav-bar">
        <button id="nav-diag" class="nav-btn active" onclick="showTab('diagnostic', this)">DIAGNOSE</button>
        <button id="nav-ctrl" class="nav-btn" onclick="showTab('controls', this)">CONTROLS</button>
        <button id="nav-breath" class="nav-btn" onclick="showTab('breath', this)">PACER</button>
        <button id="nav-data" class="nav-btn" onclick="showTab('data', this)">ARCHIVE</button>
        <button id="nav-guide" class="nav-btn" onclick="showTab('guide', this)">MANUAL</button>
    </div>

    <div class="content-wrapper" id="content-wrapper">
        
        <div id="diagnostic" class="tab-panel visible">
            <div class="doctor-header">
                <div class="doctor-avatar" onclick="handleDoctorTap()">âœš</div>
                <div class="doctor-info">
                    <div class="doctor-name">Dr. Arch</div>
                    <div>Cryo-Acoustic Specialist</div>
                </div>
                <button class="reset-btn" onclick="initChat()">RESTART CONSULTATION</button>
            </div>
            <div id="chat-window" class="chat-window"></div>
            
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Enter symptom or intent..." onkeydown="if (event.key === 'Enter') handleChatInput();">
                <button id="chat-send-btn" onclick="handleChatInput()">SEND</button>
            </div>
        </div>

        <div id="controls" class="tab-panel">
            <div class="mode-banner">
                <div>
                    <div class="current-mode-text">ENVIRONMENT</div>
                    <div class="mode-name" id="active-mode-name">--</div>
                </div>
                <button class="change-mode-btn" onclick="toggleMode()">SWITCH</button>
            </div>

            <div class="regulator-panel">
                <div class="system-label">EXTERNAL REGULATOR (Timekeeper / Hydrator)</div>
                <div class="regulator-control">
                    <div>HYDRATION STATUS:</div>
                    <button id="hydration-status" class="toggle-btn" onclick="toggleHydration()">UNCONFIRMED</button>
                </div>
                <div class="regulator-control" style="border-top: 1px solid #1a1a1a; margin-top: 5px; padding-top: 5px;">
                    <div>LIGHT SYNC:</div>
                    <button id="light-status" class="toggle-btn" onclick="toggleLight()">DEACTIVATED</button>
                </div>
            </div>

            <div class="bio-bar" id="bio-panel">
                <div>
                    <div class="bio-label">HEART RATE</div>
                    <div class="bio-val"><span id="bpm-display">--</span> <span style="font-size:12px">BPM</span></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="bio-btn" onclick="connectBluetooth()">BLE LINK</button>
                    <button class="bio-btn" onclick="tapTempo()">TAP</button>
                </div>
            </div>

            <div class="status-box">
                <div class="status-row"><span>PROTOCOL:</span><span id="geo-text" class="value-text">--</span></div>
                <div class="status-row"><span>MIND (Hz):</span><span id="freq-text" class="value-text">0 Hz</span></div>
                <div class="status-row"><span>BODY (Hz):</span><span id="vib-text" class="value-text">0 Hz</span></div>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: ORTHOPEDIC (Structural Integrity)</div>
                <button id="btn-Tetrahedron" class="med-btn border-fire" onclick="handleControlToggle('Tetrahedron')">
                    <span class="btn-icon">â–³</span>
                    <div>
                        <div class="btn-main">TETRAHEDRON</div>
                        <div class="btn-desc">Bone Density & Strength</div>
                    </div>
                    <div class="btn-meta"><div class="btn-freq">720Hz</div><div class="btn-time">24 MIN</div></div>
                </button>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: NEUROLOGY (Stability & Grounding)</div>
                <button id="btn-Cube" class="med-btn border-earth" onclick="handleControlToggle('Cube')">
                    <span class="btn-icon">â–¡</span>
                    <div>
                        <div class="btn-main">CUBE</div>
                        <div class="btn-desc">Anxiety Relief & Grounding</div>
                    </div>
                    <div class="btn-meta"><div class="btn-freq">2160Hz</div><div class="btn-time">20 MIN</div></div>
                </button>
                <button id="btn-Octahedron" class="med-btn border-air" onclick="handleControlToggle('Octahedron')">
                    <span class="btn-icon">â—‡</span>
                    <div>
                        <div class="btn-main">OCTAHEDRON</div>
                        <div class="btn-desc">Mental Focus & Balance</div>
                    </div>
                    <div class="btn-meta"><div class="btn-freq">1440Hz</div><div class="btn-time">15 MIN</div></div>
                </button>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: VASCULAR (Flow & Fluids)</div>
                <button id="btn-Icosahedron" class="med-btn border-water" onclick="handleControlToggle('Icosahedron')">
                    <span class="btn-icon">ðŸ’§</span>
                    <div><div class="btn-main">ICOSAHEDRON</div><div class="btn-desc">Inflammation & Flow</div></div>
                    <div class="btn-meta"><div class="btn-freq">360Hz</div><div class="btn-time">18 MIN</div></div>
                </button>
                <button id="btn-Torus" class="med-btn border-void" onclick="handleControlToggle('Torus')">
                    <span class="btn-icon">â—Ž</span>
                    <div><div class="btn-main">TORUS</div><div class="btn-desc">Heart Coherence & Stagnation</div></div>
                    <div class="btn-meta"><div class="btn-freq">194Hz</div><div class="btn-time">22 MIN</div></div>
                </button>
            </div>

            <div class="system-group">
                <div class="system-label">SYSTEM: CELLULAR & FIELD (Repair)</div>
                <button id="btn-Dodecahedron" class="med-btn border-aether" onclick="handleControlToggle('Dodecahedron')">
                    <span class="btn-icon">â¬¡</span>
                    <div><div class="btn-main">DODECAHEDRON</div><div class="btn-desc">DNA Repair & Toxicity</div></div>
                    <div class="btn-meta"><div class="btn-freq">432Hz</div><div class="btn-time">33 MIN</div></div>
                </button>
                <button id="btn-Sphere" class="med-btn border-void" onclick="handleControlToggle('Sphere')">
                    <span class="btn-icon">â—¯</span>
                    <div><div class="btn-main">SPHERE</div><div class="btn-desc">EMF Protection Shield</div></div>
                    <div class="btn-meta"><div class="btn-freq">7.83Hz</div><div class="btn-time">45 MIN</div></div>
                </button>
            </div>
        </div>

        <div id="breath" class="tab-panel">
            <div style="text-align: center; color: #00e5ff; margin-bottom: 20px;">COHERENCE PROTOCOL (0.1 Hz)</div>
            <div class="breath-box">
                <div id="breath-circle" class="circle"></div>
                <h2 id="breath-text" style="margin-top: 30px;">READY</h2>
            </div>
            <button class="apply-btn" style="margin-top:20px; background:transparent; border:1px solid #00e5ff; color:#00e5ff;" onclick="toggleBreath()">START PACER</button>
        </div>

        <div id="data" class="tab-panel">
            <h3 style="color: #00e5ff; border-bottom: 1px solid #333; padding-bottom: 10px;">PATIENT RECORDS</h3>
            <div class="instruct-text">LONG PRESS TO COPY LOGS</div>
            <textarea id="log-terminal" class="terminal-window" readonly>NO RECORDS FOUND.</textarea>
            <div class="data-controls">
                <button class="data-btn" onclick="selectAllData()">SELECT ALL</button>
                <button class="data-btn" style="color:#ff5252; border-color:#552222;" onclick="clearData()">CLEAR RECORDS</button>
            </div>
        </div>

        <div id="guide" class="tab-panel">
            <h3 style="color:#ffd700">CLINICAL GUIDE</h3>
            <p><strong>1. DIAGNOSTIC FIRST</strong><br>Dr. Arch will ask you to define your Intent (Repair vs. Optimize) before selecting a protocol.</p>
            <p><strong>2. AUTO-DOSING</strong><br>The system sets the exact duration needed for your specific tissue type (e.g. Bone requires 24min, Blood requires 18min).</p>
            <p><strong>3. MODALITIES</strong><br>[VEHICLE] = Chassis Resonance.<br>[HEADSET] = Binaural Entrainment.</p>
        </div>
    </div>

    <div class="global-footer" id="global-footer" style="display: none;">
        <button id="global-btn" class="global-btn btn-idle" onclick="handleGlobalClick()">SELECT PROTOCOL</button>
    </div>

    <script>
        // --- SYSTEM VARS (DEFINED FIRST FOR SCOPE) ---
        let audioCtx = null; let masterGain; let systemMode = 'headset'; 
        let oscHigh, oscLow, oscBin;
        let currentBPM=0; let startBPM=0; let tapTimes=[];
        let sessionStart=0; let currentGeo=""; let currentHigh=0; currentLow=0;
        let breathTimer=null; let isPlaying=false;
        let lastGeo = null; let lastHigh = 0; lastLow = 0; let pendingDiagnosis = null;
        let doseTimer = null; let remainingSeconds = 0;
        let tapCounter = 0; 
        let hydrationStatus = false; 
        let lightStatus = false; 
        let chatState = 'start'; 
        let filterNode = null;

        // --- CORE FUNCTION DEFINITIONS (ABSOLUTE GLOBAL PRIORITY) ---

        function getBaseGeoName(name) {
             // Strips the intent suffix to get the base ID for UI activation
             if (name.includes('DISCHARGE_33')) return 'Tetrahedron'; // Discharge uses Tetrahedron visual spot
             if (name.includes('Stellated_Dodecahedron')) return 'Dodecahedron'; 
             if (name.includes('Icosahedron_Intent')) return 'Icosahedron';
             return name; // Base geometry
        }

        function initAudio() { 
            if (!audioCtx){
                const AC=window.AudioContext||window.webkitAudioContext; audioCtx=new AC(); 
                masterGain=audioCtx.createGain(); 
                
                filterNode = audioCtx.createBiquadFilter();
                filterNode.type = 'lowpass';
                filterNode.frequency.setValueAtTime(1200, audioCtx.currentTime); 
                
                filterNode.connect(masterGain);
                masterGain.connect(audioCtx.destination);
            } else if(audioCtx.state==='suspended') {
                audioCtx.resume();
            }
        }
        
        function showTab(id, btn) { 
            // Ensure audio is initialized on first tab click
            if (!audioCtx) initAudio(); 
            
            document.querySelectorAll('.tab-panel').forEach(e=>e.classList.remove('visible')); document.getElementById(id).classList.add('visible'); 
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); 
            if(id==='diagnostic' && document.getElementById('chat-window').innerHTML==="") initChat(); 
            if(id==='data') loadData(); 
        }

        function showPreSessionModal(name) {
            pendingDiagnosis = name;

            const p = protocolData[name];
            const isHeadset = systemMode === 'headset';
            const targetVolume = isHeadset ? p.h_vol : p.v_vol;
            
            const modeText = isHeadset ? `HEADSET MODE: Binaural Entrainment is active.` : `VEHICLE MODE: Chassis Vibration is active.`;
            const volumeInstruction = `Set device volume to **${targetVolume}** for optimal clinical amplitude.`;

            document.getElementById('modal-title').innerText = `PROTOCOL: ${name.toUpperCase().replace('_INTENT', '').replace('_EXPLODE', '').replace('DISCHARGE_33', 'GAMMA DISCHARGE').replace('_DODECAHEDRON', ' DODECAHEDRON')}`;
            document.getElementById('modal-instruct-text').innerHTML = `
                <div style="font-weight: bold; color: #fff;">${modeText} | RX TIME: ${p.d}</div>
                <div class="modal-warn" style="margin-top: 10px;">${volumeInstruction}</div>
                <div style="margin-top: 10px; color: #ffd700;">Clinical Focus: ${p.msg}</div>
            `;
            document.getElementById('modal-instruct-text').innerHTML += `
                <div class="volume-visual">}</div>
            `;
            document.getElementById('pre-session-modal').style.display = 'flex';
        }

        function handleControlToggle(name) {
            // Checks if the protocol is already playing AND if the click is on its own button
            if (isPlaying && currentGeo === name) {
                stopAll(true);
            } else {
                // If stopped or clicking a different button, initiate start sequence (via modal)
                showPreSessionModal(name);
            }
        }

        function startTreatmentNow() {
            document.getElementById('pre-session-modal').style.display = 'none';
            if (pendingDiagnosis) {
                playFreq(pendingDiagnosis);
                pendingDiagnosis = null;
            } else if (lastGeo) {
                playFreq(lastGeo); 
            }
        }
        
        function playFreq(name) {
            initAudio(); 
            // CRITICAL: Resume audio just before playback starts
            if (audioCtx.state === 'suspended') audioCtx.resume(); 

            stopAll(false);
            const p = protocolData[name];
            let currentGeo = name; // Update currentGeo immediately
            sessionStart=Date.now(); startBPM=currentBPM; currentHigh=p.f; currentLow=p.l;
            lastGeo=name; isPlaying=true; remainingSeconds = p.t;

            document.querySelectorAll('.med-btn').forEach(b=>b.classList.remove('active-protocol'));
            
            // UI Activation Fix: Ensure the ID matches the HTML button exactly
            const btnId = 'btn-' + getBaseGeoName(name);
            const targetButton = document.getElementById(btnId);
            if (targetButton) {
                targetButton.classList.add('active-protocol');
            }
            
            updateStatus("TREATING","#00e5ff",name,p.f,p.l); 
            
            // Determine Gains (Automated Volume)
            const MIND_GAIN = 0.15;
            let highGain = (name === 'DISCHARGE_33') ? 0.4 : MIND_GAIN; 
            let lowGain = (systemMode === 'vehicle') ? 0.8 : 0.4;
            let waveType = p.w;

            const now = audioCtx.currentTime;
            const globalVoiceGain = audioCtx.createGain();
            globalVoiceGain.connect(filterNode);
            
            if (systemMode === 'vehicle') {
                // VEHICLE MODE (Physical)
                oscHigh=audioCtx.createOscillator(); oscHigh.type=waveType; oscHigh.frequency.value=p.f; let g1=audioCtx.createGain(); g1.gain.value=highGain; oscHigh.connect(g1); g1.connect(globalVoiceGain); oscHigh.start();
                oscLow=audioCtx.createOscillator(); oscLow.type=waveType; oscLow.frequency.value=p.l; let g2=audioCtx.createGain(); g2.gain.value=lowGain; oscLow.connect(g2); g2.connect(globalVoiceGain); oscLow.start();
                if(p.f>60){oscBin=audioCtx.createOscillator(); oscBin.type='sine'; oscBin.frequency.value=p.f+7.83; let g3=audioCtx.createGain(); g3.gain.value=0.05; oscBin.connect(g3); g3.connect(globalVoiceGain); oscBin.start();}
            } else {
                // HEADSET MODE (Binaural)
                let pL=audioCtx.createStereoPanner(); pL.pan.value=-1; pL.connect(globalVoiceGain); let pR=audioCtx.createStereoPanner(); pR.pan.value=1; pR.connect(globalVoiceGain); let pC=audioCtx.createStereoPanner(); pC.pan.value=0; pC.connect(globalVoiceGain);
                
                oscHigh=audioCtx.createOscillator(); oscHigh.type=waveType; oscHigh.frequency.value=p.f; let g1=audioCtx.createGain(); g1.gain.value=highGain; oscHigh.connect(g1); g1.connect(pL); oscHigh.start();
                oscBin=audioCtx.createOscillator(); oscBin.type=waveType; oscBin.frequency.value=p.f+7.83; let g3=audioCtx.createGain(); g3.gain.value=highGain; oscBin.connect(g3); g3.connect(pR); oscBin.start();
                oscLow=audioCtx.createOscillator(); oscLow.type='sine'; oscLow.frequency.value=p.l; let g2=audioCtx.createGain(); g2.gain.value=lowGain; oscLow.connect(g2); g2.connect(pC); oscLow.start();
            }

            // ENVELOPE: Apply fast attack for Explosive Mode
            if (name === 'DISCHARGE_33') {
                globalVoiceGain.gain.setValueAtTime(0.0001, now);
                globalVoiceGain.gain.exponentialRampToValueAtTime(1.0, now + 0.05); // Fast snap
            } else {
                globalVoiceGain.gain.setValueAtTime(1.0, now); // Standard immediate volume
            }

            // Start Timer
            startTimer();
        }


        // --- REST OF THE CODE (DEFINED AFTER) ---

        function startTimer() {
            if(doseTimer) clearInterval(doseTimer);
            updateGlobalBtn(); 
            doseTimer = setInterval(() => {
                remainingSeconds--;
                if(remainingSeconds <= 0) {
                    stopAll(true);
                    alert("CLINICAL DOSAGE COMPLETE.");
                } else {
                    updateGlobalBtn();
                }
            }, 1000);
        }

        function stopAll(save) {
            if(doseTimer) clearInterval(doseTimer); doseTimer = null;
            if(oscHigh){try{oscHigh.stop();}catch(e){} oscHigh=null;} if(oscLow){try{oscLow.stop();}catch(e){} oscLow=null;} if(oscBin){try{oscBin.stop();}catch(e){} oscBin=null;}
            document.querySelectorAll('.med-btn').forEach(b=>b.classList.remove('active-protocol'));
            updateStatus("STANDBY","#fff","--",0,0); isPlaying=false; updateGlobalBtn();
            if(save && currentGeo && sessionStart>0) {
                const dur=Math.round((Date.now()-sessionStart)/1000);
                let drop = (startBPM>0 && currentBPM>0) ? (startBPM-currentBPM) : 0;
                saveSession(currentGeo, currentHigh, currentLow, dur, systemMode, drop);
                currentGeo=""; sessionStart=0;
            }
        }

        function updateStatus(s,c,n,h,l) { 
            let display_name = n.replace('_Intent', '').replace('_Explode', '').replace('DISCHARGE_33', 'GAMMA DISCHARGE').replace('_DODECAHEDRON', ' DODECAHEDRON');
            document.getElementById('geo-text').innerText=display_name; document.getElementById('geo-text').style.color=c; 
            document.getElementById('freq-text').innerText=h+" Hz"; document.getElementById('vib-text').innerText=l+" Hz"; 
        }
        
        function handleGlobalClick() { 
            if(isPlaying){stopAll(true);}
            else if(lastGeo){showPreSessionModal(lastGeo);}
            else{showTab('controls',document.getElementById('nav-ctrl'));} 
        }
        
        function updateGlobalBtn() { 
            const b=document.getElementById('global-btn'); b.className='global-btn'; 
            if(isPlaying){
                let m = Math.floor(remainingSeconds / 60);
                let s = remainingSeconds % 60;
                let txt = (s < 10) ? "0"+s : s;
                b.classList.add('btn-active');
                b.innerText = `TREATING: ${m}:${txt} (TAP TO STOP)`;
            } else if(lastGeo){
                b.classList.add('btn-resume');
                b.innerText = "RESUME: "+lastGeo.replace('_Intent', '').replace('_Explode', '').replace('DISCHARGE_33', 'GAMMA DISCHARGE').replace('_DODECAHEDRON', ' DODECAHEDRON');
            } else {
                b.classList.add('btn-idle');
                b.innerText = "SELECT PROTOCOL";
            } 
        }

        // --- BIO & ARCHIVE ---
        async function connectBluetooth() { 
            if (!audioCtx || audioCtx.state === 'suspended') { 
                alert("Please tap a control button first to initialize the audio engine."); 
                return;
            }
            try{
                const d=await navigator.bluetooth.requestDevice({filters:[{services:['heart_rate']}]}); 
                const s=await d.gatt.connect(); const v=await s.getPrimaryService('heart_rate'); 
                const c=await v.getCharacteristic('heart_rate_measurement'); c.startNotifications(); 
                c.addEventListener('characteristicvaluechanged',e=>updateBio(e.target.value.getUint8(1))); 
                document.getElementById('bio-panel').style.borderColor="#00e5ff";}catch(e){alert("BLE Failed.");} 
        }
        function tapTempo() { 
            if (!audioCtx || audioCtx.state === 'suspended') { 
                alert("Please tap a control button first to initialize the audio engine."); 
                return;
            }
            const n=Date.now(); tapTimes.push(n); if(tapTimes.length>4)tapTimes.shift(); if(tapTimes.length>=2){let i=[]; for(let x=1;x<tapTimes.length;x++)i.push(tapTimes[x]-tapTimes[x-1]); updateBio(Math.round(60000/(i.reduce((a,b)=>a+b)/i.length)));} 
        }
        function updateBio(b) { currentBPM=b; if(startBPM===0)startBPM=b; document.getElementById('bpm-display').innerText=b; document.getElementById('bio-panel').style.borderColor=(b>90)?"#ff5252":"#00e5ff"; }
        function saveSession(t, h, l, d, m, drop) {
            const logs = JSON.parse(localStorage.getItem('cryo_logs_v20') || "[]");
            const dateStr = new Date().toISOString().substring(0,16).replace('T',' ');
            let modeTag = (m === 'vehicle') ? "[PHYS]" : "[NEURO]";
            let eff = (drop > 0) ? `EFF:+${drop}` : (drop < 0) ? `EFF:${drop}` : `EFF:--`;
            const entry = `${dateStr} | ${modeTag} | ${t.padEnd(12)} | ${d}s | ${eff}`;
            logs.unshift(entry); if(logs.length>200)logs.pop();
            localStorage.setItem('cryo_logs_v20', JSON.stringify(logs));
        }
        function loadData() {
            const logs = JSON.parse(localStorage.getItem('cryo_logs_v20') || "[]");
            const tm = document.getElementById('log-terminal');
            if (logs.length === 0) { tm.value = "NO RECORDS."; return; }
            let out = "DATE             | ENV    | PROTOCOL     | DUR   | RESULT\n-----------------------------------------------------------\n";
            logs.forEach(l => out += l + "\n"); tm.value = out;
        }
        function selectAllData() { const t=document.getElementById('log-terminal'); t.select(); t.setSelectionRange(0,99999); }
        function clearData() { if(confirm("DELETE ALL RECORDS?")) { localStorage.removeItem('cryo_logs_v20'); loadData(); } }
        function toggleBreath() { const c=document.getElementById('breath-circle'); const l=document.getElementById('breath-text'); if(isBreathing){isBreathing=false; clearTimeout(breathTimer); c.className="circle"; l.innerText="READY"; l.style.color="#fff";} else{isBreathing=true; loopBreath(c,l,'in');} }
        function loopBreath(c,l,p) { if(!isBreathing)return; if(p==='in'){c.className="circle inhale"; l.innerText="INHALE"; l.style.color="#00e5ff"; breathTimer=setTimeout(()=>loopBreath(c,l,'out'),5500);} else{c.className="circle exhale"; l.innerText="EXHALE"; l.style.color="#555"; breathTimer=setTimeout(()=>loopBreath(c,l,'in'),5500);} }

        // --- ENVIRONMENTAL REGULATOR LOGIC ---
        function updateRegulatorDisplay() {
            const hBtn = document.getElementById('hydration-status');
            const lBtn = document.getElementById('light-status');

            hBtn.innerText = hydrationStatus ? 'CONFIRMED' : 'UNCONFIRMED';
            hBtn.classList.toggle('status-active', hydrationStatus);
            
            lBtn.innerText = lightStatus ? 'ACTIVE' : 'DEACTIVATED';
            lBtn.classList.toggle('status-active', lightStatus);
        }

        function toggleHydration(shouldSave = true) {
            hydrationStatus = !hydrationStatus;
            updateRegulatorDisplay();
            if (shouldSave) localStorage.setItem('cryo_hydration', hydrationStatus);
        }
        
        function toggleLight(shouldSave = true) {
            lightStatus = !lightStatus;
            updateRegulatorDisplay();
            if (shouldSave) localStorage.setItem('cryo_light', lightStatus);
        }
    </script>
</body>
</html>
